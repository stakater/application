suite: CronJob

templates:
  - cronjob.yaml

tests:
  - it: does not fail rendering when job image tag and digest are absent
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: ""
              digest: ""
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: example-image

  - it: fails rendering when job image repository is not given
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: ""
              tag: doesnt
              digest: matter
    asserts:
      - failedTemplate:
          errorMessage: "Undefined image repo for container 'example'"

  - it: uses tag when defined
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
              digest: ""
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: example-image:example-tag

  - it: uses digest when defined
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: ""
              digest: sha256:example-digest
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: example-image@sha256:example-digest

  - it: uses both tag and digest when given both
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
              digest: sha256:example-digest
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: example-image:example-tag@sha256:example-digest

  - it: applies the annotations correctly to the cronjob
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
              digest: sha256:example-digest
            annotations:
              foo: "bar"
              bar: "baz"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            foo: "bar"
            bar: "baz"

  - it: applies the additionalPodAnnotations correctly on the pods
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
              digest: sha256:example-digest
            additionalPodAnnotations:
              helm.sh/hook: "pre-install,pre-upgrade"
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.metadata.annotations
          value:
            helm.sh/hook: "pre-install,pre-upgrade"

  - it: includes activeDeadlineSeconds when set to 0
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
            activeDeadlineSeconds: 0
    asserts:
      - isNotNull:
          path: spec.jobTemplate.spec.activeDeadlineSeconds
      - equal:
          path: spec.jobTemplate.spec.activeDeadlineSeconds
          value: 0

  - it: includes startingDeadlineSeconds when set to 0
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
            startingDeadlineSeconds: 0
    asserts:
      - isNotNull:
          path: spec.jobTemplate.spec.startingDeadlineSeconds
      - equal:
          path: spec.jobTemplate.spec.startingDeadlineSeconds
          value: 0

  - it: includes both activeDeadlineSeconds and startingDeadlineSeconds when set to 0
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
            activeDeadlineSeconds: 0
            startingDeadlineSeconds: 0
    asserts:
      - isNotNull:
          path: spec.jobTemplate.spec.activeDeadlineSeconds
      - equal:
          path: spec.jobTemplate.spec.activeDeadlineSeconds
          value: 0
      - isNotNull:
          path: spec.jobTemplate.spec.startingDeadlineSeconds
      - equal:
          path: spec.jobTemplate.spec.startingDeadlineSeconds
          value: 0

  - it: includes activeDeadlineSeconds when set to positive integer
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
            activeDeadlineSeconds: 300
    asserts:
      - isNotNull:
          path: spec.jobTemplate.spec.activeDeadlineSeconds
      - equal:
          path: spec.jobTemplate.spec.activeDeadlineSeconds
          value: 300

  - it: includes declared init jobs without duplicate names
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
            initContainers:
              example1:
                name: shouldnotmatter
                image: example-image:example-tag
              example2:
                image: example-image:example-tag
    asserts:
      - isNotNull:
          path: spec.jobTemplate.spec.template.spec.initContainers
      - contains:
          path: spec.jobTemplate.spec.template.spec.initContainers
          content:
            name: example1
            image: example-image:example-tag
      - contains:
          path: spec.jobTemplate.spec.template.spec.initContainers
          content:
            name: example2
            image: example-image:example-tag
      - notContains:
          path: spec.jobTemplate.spec.template.spec.initContainers
          content:
            name: shouldnotmatter
            image: example-image:example-tag

  - it: includes app.kubernetes.io/name label in pod template
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
      applicationName: my-app
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.metadata.labels["app.kubernetes.io/name"]
          value: my-app

  - it: includes application.stakater.com/workload-class label with value scheduled in pod template
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
      applicationName: my-app
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.metadata.labels["application.stakater.com/workload-class"]
          value: scheduled

  - it: uses image templating
    set:
      custom:
        image:
          repository: custom-image
          tag: custom-tag
          digest: sha256:custom-digest
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: "{{ .Values.custom.image.repository }}"
              tag:  "{{ .Values.custom.image.tag }}"
              digest: "{{ .Values.custom.image.digest }}"
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: custom-image:custom-tag@sha256:custom-digest

  - it: uses image templating (without tag)
    set:
      custom:
        image:
          repository: custom-image
          digest: sha256:custom-digest
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: "{{ .Values.custom.image.repository }}"
              tag:  "{{ .Values.custom.image.tag }}"
              digest: "{{ .Values.custom.image.digest }}"
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: custom-image@sha256:custom-digest

  - it: uses image templating (without digest)
    set:
      custom:
        image:
          repository: custom-image
          tag: custom-tag
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: "{{ .Values.custom.image.repository }}"
              tag:  "{{ .Values.custom.image.tag }}"
              digest: "{{ .Values.custom.image.digest }}"
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: custom-image:custom-tag

  - it: uses image templating (without tag and digest)
    set:
      custom:
        image:
          repository: custom-image
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: "{{ .Values.custom.image.repository }}"
              tag:  "{{ .Values.custom.image.tag }}"
              digest: "{{ .Values.custom.image.digest }}"
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.containers[0].image
          value: custom-image

  - it: configures automount service account token by default
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            image:
              repository: example-image
              tag: example-tag
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.automountServiceAccountToken
          value: true

  - it: enable automount service account token when configured
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            automountServiceAccountToken: true
            image:
              repository: example-image
              tag: example-tag
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.automountServiceAccountToken
          value: true

  - it: disable automount service account token when configured
    set:
      cronJob:
        enabled: true
        jobs:
          example:
            automountServiceAccountToken: false
            image:
              repository: example-image
              tag: example-tag
    asserts:
      - equal:
          path: spec.jobTemplate.spec.template.spec.automountServiceAccountToken
          value: false
